using BenchmarkParsing;
using System;
using System.Globalization;
using System.Security;
using System.Text.Json;
using System.Text.Json.Nodes;
using static BenchmarkParsing.BenchmarkParser;

namespace UncertaintyExperiments
{
    internal class Program
    {

        // Test CAse
        static void Test()
        {
            int[] sequence = [3, 0, 0, 7, 4, 10, 10, 11, 11, 6, 3, 4, 4, 6, 7, 0, 1, 8, 0, 10, 7, 1, 8, 4, 10, 6, 11, 2, 9, 1, 6, 9, 8, 2, 5, 3, 3, 11, 8, 1, 5, 9, 7, 2, 9, 2, 5, 5];
            int[] machines = [2, 6, 6, 7, 0, 1, 6, 7, 1, 3, 3, 7, 0, 4, 3, 5, 0, 4, 1, 7, 1, 2, 4, 6, 1, 4, 4, 4, 3, 5, 6, 6, 1, 2, 6, 5, 3, 5, 4, 6, 1, 3, 6, 5, 2, 2, 4, 7];
            int[] worker = [5, 5, 10, 4, 7, 2, 7, 5, 1, 2, 4, 4, 1, 9, 0, 9, 2, 3, 8, 3, 9, 10, 2, 1, 1, 9, 10, 4, 7, 2, 8, 7, 8, 9, 8, 6, 5, 11, 1, 1, 4, 6, 2, 7, 11, 9, 4, 3];
            WorkerBenchmarkParser parser = new WorkerBenchmarkParser();
            WorkerEncoding encoding = parser.ParseBenchmark("C:\\Users\\huda\\Downloads\\paper_results\\paper_results\\benchmarks_with_workers\\6_Fattahi_20_workers.fjs");
            float expected = 1274.0f;
            float[,,] d = new float[encoding.Durations.GetLength(0), encoding.Durations.GetLength(1), encoding.Durations.GetLength(2)];
            for(int i = 0; i < d.GetLength(0); i++)
            {
                for(int j = 0; j <  d.GetLength(1); j++)
                {
                    for(int k = 0; k <  d.GetLength(2); k++)
                    {
                        d[i, j, k] = encoding.Durations[i, j, k];
                    }
                }
            }
            Graph g = new Graph(sequence, machines, worker, encoding.JobSequence, d, new float[sequence.Length]);
            Console.WriteLine(expected);
            Console.WriteLine(g.Makespan);
            //"Best":[{ "Workers":[5,5,10,4,7,2,7,5,1,2,4,4,1,9,0,9,2,3,8,3,9,10,2,1,1,9,10,4,7,2,8,7,8,9,8,6,5,11,1,1,4,6,2,7,11,9,4,3],"Fitness":{ "Makespan":1274.0},"Feasible":true,"Sequence":[3,0,0,7,4,10,10,11,11,6,3,4,4,6,7,0,1,8,0,10,7,1,8,4,10,6,11,2,9,1,6,9,8,2,5,3,3,11,8,1,5,9,7,2,9,2,5,5],"Assignments":[2,6,6,7,0,1,6,7,1,3,3,7,0,4,3,5,0,4,1,7,1,2,4,6,1,4,4,4,3,5,6,6,1,2,6,5,3,5,4,6,1,3,6,5,2,2,4,7]}],"Parameters":{
            ////   "Durations":[[[0,0,236,231,261,0,228,0,0,257,0,0],[0,232,211,0,0,0,0,0,0,0,0,0],[93,99,102,99,0,90,107,0,95,97,102,101],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[136,136,132,122,119,139,131,0,117,130,136,124],[0,0,0,0,0,0,0,0,0,0,0,0],[134,143,0,0,0,147,138,143,153,132,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[130,0,0,0,119,116,0,0,0,115,118,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[164,157,0,157,158,160,139,135,142,158,154,147],[0,0,144,152,160,0,151,0,160,0,0,159],[0,0,0,0,0,0,0,0,0,0,0,0],[0,211,191,211,0,214,0,213,0,0,186,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[228,0,230,228,194,193,0,0,0,0,196,212],[134,0,0,154,155,131,0,0,141,0,0,0]],[[0,0,0,219,224,0,0,216,0,0,0,199],[0,0,0,0,0,0,0,0,0,0,0,0],[158,159,138,153,0,0,0,0,0,0,146,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[60,0,68,68,0,71,0,0,70,67,66,0],[0,0,0,0,0,0,91,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[184,190,188,192,193,188,178,0,164,0,0,179],[0,0,0,99,0,89,97,0,0,0,91,101],[0,141,160,153,142,147,143,151,0,0,0,141],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[124,0,120,0,0,0,109,123,123,116,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[160,0,147,143,151,135,142,137,163,136,161,159]],[[0,0,0,0,0,0,94,0,0,0,86,80],[0,61,0,0,0,65,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,185,189,165,179,0,197,0,165,186,0],[105,95,96,100,100,103,101,112,115,104,97,103],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[146,0,156,139,0,0,0,138,140,138,0,157],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,205,193,0,178,205,182,0,180,0,0,0],[0,0,97,0,109,0,98,99,0,0,99,0],[154,145,150,147,161,160,154,167,145,140,164,163],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[165,157,187,157,161,154,155,169,0,158,182,157],[0,0,0,0,0,0,0,0,0,0,0,0],[0,173,171,0,159,0,162,0,0,178,0,181]],[[0,86,82,0,93,92,85,79,90,85,91,81],[0,0,0,62,0,0,0,70,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[230,0,0,270,225,271,0,0,243,0,268,254],[0,0,0,0,0,0,0,0,0,0,0,0],[0,188,0,189,0,0,0,0,0,186,165,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[133,154,0,0,150,0,158,0,0,0,153,145],[0,0,0,0,0,0,0,0,0,0,0,0],[135,0,132,137,148,0,144,148,0,131,128,135],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,237,0,0,0,0,0,0,0,0,240],[0,0,178,0,184,165,181,0,159,156,0,186],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,128,124,138,0,132,124,137,0,119,122,128],[0,115,119,0,116,127,132,116,123,117,0,115],[146,140,133,141,153,151,156,159,158,142,157,157],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,69,0,0,0],[0,0,49,47,0,0,43,49,45,0,45,52],[0,0,0,0,0,0,0,0,0,0,0,0],[0,80,0,78,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,105,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[119,0,120,104,107,111,120,101,104,0,119,0],[89,0,88,78,84,87,88,88,81,91,89,79],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,179,0,0,0,0,172],[0,0,0,0,0,0,0,0,0,0,0,0],[179,157,157,180,156,150,161,180,153,177,159,157]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,143,150,0,0,138,144,0,135,136,142,0],[322,318,311,309,0,318,316,0,0,0,0,0],[0,0,0,0,0,0,0,0,157,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,120,121,0,119,0,114,0,135,128],[139,142,150,0,139,147,0,150,163,0,152,158],[0,0,0,0,0,0,183,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,124,111,0,0,121,0,129,0,0,108],[237,244,226,0,259,255,262,236,262,223,236,237],[0,173,189,0,0,0,0,0,0,0,162,177],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,124,127,117,116,113,109,0,128],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[51,48,0,53,0,0,48,0,0,49,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,154,0,155,0,157,147,164,166,164,0,164],[0,0,0,157,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[132,133,0,127,118,131,0,124,129,115,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,154,171,169,0,0,0,176,0,153,157,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,159,156,0,153,139,151,147,0,146,158],[165,158,156,173,161,176,160,0,0,158,175,168],[164,172,0,193,179,185,0,194,0,167,0,163],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,146,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,213,248,211,0,0,225,0,0,0,250]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[274,247,0,253,240,0,233,251,269,252,0,259],[0,0,0,0,0,0,0,246,0,0,0,225],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[265,242,0,0,0,265,281,0,0,0,271,0],[0,0,242,0,0,0,0,0,227,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,136,159,131,144,0,0,132,148,0,0,139],[174,167,181,151,173,168,175,170,179,175,167,174],[0,0,0,0,0,0,0,0,176,172,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,164,137,154,139,152,159,137,150,0,148,138],[151,0,155,164,0,0,137,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,146,0,0,0,148,0,143,137,162,0,0],[0,161,147,0,160,0,139,158,141,148,155,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,188,0,183,0,0,0,181,0,176],[216,203,204,0,205,0,214,0,239,221,229,212],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,43,0,0,43,37,0,0,38,0,44,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,46,0,45,48,0,0,54,45,0,49,49],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[159,142,141,147,154,160,158,142,135,138,151,153],[0,0,0,0,0,0,0,0,0,0,0,0],[175,0,0,0,0,0,0,167,165,161,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,280,237,0,0,0,0,0,0,0,0],[0,232,237,245,256,224,236,229,0,236,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[271,271,0,0,0,277,268,259,0,265,281,0],[0,231,0,0,0,0,0,0,0,0,0,232],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[157,145,0,0,0,0,0,0,157,0,150,0],[175,157,0,0,155,0,171,168,0,0,0,0],[191,186,167,186,187,172,178,172,179,194,193,175],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,137,139,0,0,0,0,0,0,165,0,0],[141,155,148,150,140,146,157,152,136,144,163,140]],[[0,0,0,0,0,0,0,0,0,0,0,0],[146,152,151,136,139,149,135,161,151,161,140,149],[149,0,0,0,0,0,156,148,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,182,0,0,0,182,0,0,169,195,0],[226,0,205,0,221,207,204,236,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,38,0,0,38,0,43,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[50,0,52,52,45,49,49,54,54,45,53,52],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[140,0,0,161,147,140,137,136,0,0,139,141],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,186,0,0,0,164,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[393,393,371,324,328,348,370,331,0,388,386,386],[0,0,0,0,0,332,0,0,0,0,0,328],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[212,224,0,0,0,0,0,0,0,207,243,0],[0,0,0,0,0,0,0,0,0,0,0,0],[252,283,253,276,257,257,250,277,257,245,270,273],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,138,0,139,137,131,0,0,150,158,143,139],[168,172,0,0,0,0,0,170,175,181,0,0],[0,0,0,0,171,0,0,0,189,0,0,183],[0,0,0,0,0,0,0,0,0,0,0,0]],[[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,358,354,323,0,343,0,0,0,0,0,344],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,218,245,0,224,248,0,252,239,230]]],"JobSequence":[0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,6,6,6,6,7,7,7,7,8,8,8,8,9,9,9,9,10,10,10,10,11,11,11,11]
        }

        static void PrepareFile(string filename)
        {
            File.AppendAllText(filename, "{\"results\":[");
        }

        static void DelimitRun(string filename)
        {
            File.AppendAllText(filename, ",");
        }

        static void EndFile(string filename)
        {
            File.AppendAllText(filename, "];");
        }

        static void Main(string[] args)
        {
            //Test();
            
            //try
            //{
                string inputString = args[0];
                FileStream stream = File.OpenRead(inputString);
                Dictionary<string, string> data = JsonSerializer.Deserialize<Dictionary<string, string>>(stream);
                //JsonNode data = JsonArray.Parse(inputString);
                string basepath = (string)data["path"];
                int maxGenerations = (int)int.Parse(data["maxGenerations"]);
                int timeLimit = (int)int.Parse(data["timeLimit"]);
                float targetFitness = (float)float.Parse(data["targetFitness"]);
                int maxFunctionEvaluations = (int)int.Parse(data["maxFevals"]);

                bool[] criteriaStatus = { maxGenerations > 0, timeLimit > 0, targetFitness > 0.0f, maxFunctionEvaluations > 0 };
                if (!(criteriaStatus[0] || criteriaStatus[1] || criteriaStatus[2] || criteriaStatus[3]))
                {
                    Console.WriteLine("No valid stopping criteria was set!");
                    return;
                }

                bool keepMultiple = (bool)bool.Parse(data["keepMultiple"]);
                string instance = (string)data["instanceName"];
                string experimentName = (string)data["name"];

                string outPath = (string)data["outputPath"];
                int nExperiments = (int)int.Parse(data["nExperiments"]);

                int iteration = int.Parse(args[1]);

                int populationSize = (int)int.Parse(data["populationSize"]);
                int offspringAmount = (int)int.Parse(data["offspringAmount"]);
                float populationSizeGrowthRate = (float)float.Parse(data["populationGrowthRate"]);
                int maxPopulationSize = (int)int.Parse(data["maxPopulationSize"]);
                float offspringRate = (float)float.Parse(data["offspringRate"]);
                float mutationProbability = (float)float.Parse(data["mutationProbability"]);
                bool adaptMutationProbability = (bool)bool.Parse(data["adaptMutationProbability"]);
                float maxMutationProbability = (float)float.Parse(data["maxMutationProbability"]);
                float elitismRate = (float)float.Parse(data["elitismRate"]);
                int tournamentSize = (int)int.Parse(data["tournamentSize"]);
                //bool adaptRates = (bool)data["adaptRates"];
                bool adaptTournamentSize = (bool)bool.Parse(data["adaptTournamentSize"]);
                bool adaptElitismRate = (bool)bool.Parse(data["adaptElitismRate"]);
                float maxElitism = (float)float.Parse(data["maxElitism"]);
                float maxTournament = (float)float.Parse(data["maxTournamentRate"]);
                bool doRestarts = (bool)bool.Parse(data["doRestarts"]);
                int restartGenerations = (int)int.Parse(data["restartGenerations"]);

                string mutationMethod = (string)data["mutationMethod"];
                string recombinationMethod = (string)data["recombinationMethod"];
                string mutationGrowthMethod = (string)data["mutationGrowthMethod"];

                GA.SORT = true;
                WorkerBenchmarkParser parser = new WorkerBenchmarkParser();
                WorkerEncoding encoding = parser.ParseBenchmark(basepath);
                WorkerDecisionVariables variables = new WorkerDecisionVariables(encoding);

                GAConfiguration config = new GAConfiguration(encoding, variables);
                config.PopulationSize = populationSize;
                config.OffspringAmount = offspringAmount;
                config.PopulationSizeGrowthRate = populationSizeGrowthRate;
                config.MaxPopulationSize = maxPopulationSize;
                config.OffspringRate = offspringRate;
                config.MutationProbability = mutationProbability;
                config.MaxMutationProbability = maxMutationProbability;
                config.ElitismRate = elitismRate;
                config.TournamentSize = tournamentSize;
                config.MaxElitismRate = maxElitism;
                config.MaxTournamentRate = maxTournament;
                config.RestartGenerations = restartGenerations;

                config.AdaptMutationProbability = adaptMutationProbability;
                config.AdaptTournamentSize = adaptTournamentSize;
                config.AdaptElitismRate = adaptElitismRate;
                //config.AdaptRates = adaptRates;
                config.DoRestarts = doRestarts;

                bool simulateUncertainty = (bool)bool.Parse(data["simulateUncertainty"]);
                List<Tuple<float, float>> uncertaintyParameters = new List<Tuple<float, float>>();
                int nSimulations = (int)int.Parse(data["nSimulations"]);
                Random random = new Random();
                for (int i = 0; i < config.NWorkers; ++i)
                {
                    float alpha = (float)random.NextDouble();
                    float beta = 10.0f * alpha;
                    Tuple<float, float> values = new Tuple<float, float>(alpha, beta);
                    uncertaintyParameters.Add(values);
                }

                GA ga = new GA(config, true, encoding.Durations, recombinationMethod: recombinationMethod, mutationMethod: mutationMethod, mutationRateChangeMethod: mutationGrowthMethod, simulateUncertainty:simulateUncertainty, uncertaintyParameters:uncertaintyParameters, nSimulations: nSimulations);
                ga.SetStoppingCriteriaStatus(criteriaStatus[0], criteriaStatus[1], criteriaStatus[3], criteriaStatus[2]);
                History gaResult = ga.Run(maxGenerations, timeLimit, targetFitness, maxFunctionEvaluations, keepMultiple);

                gaResult.Name = experimentName;
                string filename = outPath + gaResult.Name + ".json";
                gaResult.ToFile(filename);
                if (iteration == 0)
                {
                    PrepareFile(filename);
                }
                if (iteration != nExperiments)
                {
                    DelimitRun(filename);
                }
                else
                {
                    EndFile(filename);
                }
            //}
            //catch (Exception e)
            //{
            //    Console.WriteLine("Error during input parsing or GA execution: " + e.Message);
            //}
            
        }
    }
}
